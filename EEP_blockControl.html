<!DOCTYPE html>
<html lang="de">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<META http-equiv="Content-Script-Type" content="text/javascript">
<title>Lua Modul blockControl</title>
<meta name="description" content="Dieses Programm generiert die erforderlichen Daten für das Lua Modul 'blockControl'">
<meta name="author" content="Frank Buchholz">
<meta name="keywords" content="EEP,.anl3,blockControl" />
<meta name="language" content="de" />
<link rel="icon" href="https://www.eepforum.de/images/favicon.ico" type="image/x-icon">

<script type="text/javascript" src="js/EEP_Texts.js"></script> <!-- Load texts and translations -->
<link rel="stylesheet" href="css/EEP_Texts.css">

<script type="text/javascript" src="js/EEP_Signale_Daten.js"></script> <!-- Lade Zusatzdaten zu Signalen: Name, Signalstellungen -->

</head>

<body>

<main>

<header>
<h3><span lang="de">EEP-Modul 'blockControl'</span><span lang="en">EEP module 'blockControl'</span><span lang="fr">EEP module 'blockControl'</span></h3>
</header>

<article>
<p><span lang="de">Daten für das Lua-Modul "blockControl" erstellen.</span><span lang="en">Create data for Lua module "blockControl".</span><span lang="fr">Créez des données pour le module Lua "blockControl".</span></p>
<ol>
<li><span lang="de">Öffnen Sie das EEP-Layout im 'Gleisplan'-Programm in einem anderen Fenster oder Tab desselben Browsers.</span><span lang="en">Open the EEP layout in the 'Gleisplan' program in another windor or tab of the same browser.</span><span lang="fr">Ouvrez la mise en page EEP dans le programme 'Gleisplan' dans un autre volet ou onglet du même navigateur.</span></li>
<li><span lang="de">Generieren Sie die Daten.</span><span lang="en">Generate the data.</span><span lang="fr">Générez les données.</span></li>
</ol>

<form id="form">
	<table>
		<tr><td><span lang="de">Gleissystem</span><span lang="en">Track system</span><span lang="fr">Système de voies</span>:</td>
			<td><label><input type="radio" name="GleissystemID" value="1" checked><span lang="de">Eisenbahn</span><span lang="en">Railroad</span><span lang="fr">Ferroviaire</span></label>
				<label><input type="radio" name="GleissystemID" value="2"><span lang="de">Straßenbahn</span><span lang="en">Tram</span><span lang="fr">Tram</span></label>
				<label><input type="radio" name="GleissystemID" value="3"><span lang="de">Straße</span><span lang="en">Road</span><span lang="fr">Routière</span></label>
				<label><input type="radio" name="GleissystemID" value="4"><span lang="de">Wasserwege</span><span lang="en">Waterways</span><span lang="fr">Navigable</span></label>
				<label><input type="radio" name="GleissystemID" value="5"><span lang="de">Steuerstrecken</span><span lang="en">Control routes</span><span lang="fr">Itinéraires de contrôle</span></label>
				<!-- <label><input type="radio" name="GleissystemID" value="6"><span lang="de">GBS</span><span lang="en">GBS</span><span lang="fr">GBS</span></label> -->
			</td></tr>
		<tr><td><label><span lang="de">Block-Signale (optional)</span><span lang="en">Block signals (optional)</span><span lang="fr">Block-Signale (optional)</span>:</td>
		<td><input id="blockSignalsString" type="text" size="70">
		<span lang="de">Nur diese Signale werden als Block-Signale verwendet (leer: alle)</span><span lang="en">Only these signals are used as block signals (blank: all)</span><span lang="fr">Seuls ces signaux sont utilisés comme signaux de bloc (vide : tous)</span>
		</td></label></tr>
		
		<tr><label><td><span lang="de">Andere Signale (optional)</span><span lang="en">Other signals (optional)</span><span lang="fr">Block-Signale (optional)</span>:</td>
		<td><input id="otherSignalsString" type="text" size="70">
		<span lang="de">Diese Signale werden nicht als Block-Signale verwendet (leer: keine)</span><span lang="en">These signals are not used as block signals (blank: none)</span><span lang="fr">Ces signaux ne sont pas utilisés comme signaux de bloc (vide : aucun)</span>
		</td></label></tr>
		
		<tr><label><td><span lang="de">Max. Anzahl der Weichen</span><span lang="en">Max. count of turnouts</span><span lang="fr">Max. nombre de aiguillages</span>:</td>
		<td><input id="maxTurnouts" type="number" value="15"></td></label></tr>
		
		<tr><label><td><span lang="de">Erweiterte Daten</span><span lang="en">Extended data</span><span lang="fr">Données étendues</span>:</td>
		<td><input id="extended" type="checkbox"></td></label></tr>
	</table>
	<br>
	<button type="submit"><span lang="de">Generieren</span><span lang="en">Generate</span><span lang="fr">Générer</span></button>
</form>
</article>
<section>
<p id="msg"></p>
<pre id="data"></pre>
</section>

<script type="text/javascript"> // Create data for Lua module "blockControl"
"use strict";

// Remaining part of main script in EEP
const LuaCode = `
-- @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
-- Remaining part of main script in EEP
-- @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@

clearlog()

local blockControl = require("blockControl")   -- Load the module

blockControl.init({                 -- Initialize the module
  logLevel        = 1,              -- (Optional) Log level 0 (default): off, 1: normal, 2: full, 3: extreme

  trains          = trains,         -- (Optional) Unknown trains get detected automatically, however, such trains do not have a train signal and can go everywhere.
  
  blockSignals    = block_signals,  -- Block signals
  twoWayBlocks    = two_way_blocks, -- Two way twin blocks (array or set of related blocks)
  routes          = routes,         -- Routes via turnouts from one block to the next block
  paths           = anti_deadlock_paths, -- Critical paths on which trains have to go to avoid lockdown situations

  MAINSW          = main_signal,    -- ID of the main switch (optional)

  MAINON          = 1,              -- ON    state of main switch
  MAINOFF         = 2,              -- OFF   state of main switch
  BLKSIGRED       = 1,              -- RED   state of block signals
  BLKSIGGRN       = 2,              -- GREEN state of block signals
  TRAINSIGRED     = 1,              -- RED   state of train signals
  TRAINSIGGRN     = 2,              -- GREEN state of train signals
})

--[[ Optional: Set one or more runtime parameters at any time 
blockControl.set({
  logLevel        = 1,              -- (Optional) Log level 0 (default): off, 1: normal, 2: full, 3: extreme
  showTippText    = true,           -- (Optional) Show tipp texts true / false (Later you can toggle the visibility of the tipp texts using the main switch.)
  start           = false,          -- (Optional) Activate/deactivate main signal. Useful to start automatic block control after finding all known train.
  startAllTrains  = true,           -- (Optional) Activate/deactivate all train signals
})
--]]

function EEPMain()
  blockControl.run()
  return 1
end		
`;


// Initialization: Connection to a broadcast channel
// https://developer.mozilla.org/en-US/docs/Web/API/Broadcast_Channel_API
const blockControlChannel = new BroadcastChannel("blockControl");

function TrackSystemText(GleissystemID) {
	const TrackSystemTexts = {
		1 : _('Eisenbahn'),
		2 : _('Strassenbahn'),
		3 : _('Strasse'),
		4 : _('Wasserwege'),
		5 : _('Steuerstrecken'),			// nicht in EEP 9
		6 : _('GBS'),						// nicht in EEP 9
	};
	return TrackSystemTexts[GleissystemID];
}

function calculate(event) {
	event.preventDefault();
 
	const msg = document.getElementById('msg');
	msg.textContent = "";
	const data = document.getElementById('data');
	data.textContent = `Request Submitted! Time stamp: ${event.timeStamp}`;
	
	const GleissystemID 		= form.querySelector('input[name="GleissystemID"]:checked').value;

	const blockSignalsStrings 	= document.getElementById('blockSignalsString').value.match(/\d+/g);
	const blockSignals 			= (blockSignalsStrings ? blockSignalsStrings.map(Number) : null);
	
	const otherSignalsStrings 	= document.getElementById('otherSignalsString').value.match(/\d+/g);
	const otherSignals 			= (otherSignalsStrings ? otherSignalsStrings.map(Number) : null);
	
	const maxTurnouts 			= +document.getElementById('maxTurnouts').value;

	// Send request to calculate data
	blockControlChannel.postMessage({
		command			: "calculate",
		GleissystemID	: GleissystemID,
		blockSignals	: blockSignals,
		otherSignals	: otherSignals,
		maxTurnouts		: maxTurnouts,
		maxTracks		: 1000,
	});  
}

const form = document.getElementById('form');
form.addEventListener('submit', calculate);

// Initialization: Connection to a broadcast channel
const EEPchannel = new BroadcastChannel('EEP');

function postIDMessage(ID, GleissystemID, GleisID) { // Signal oder Weiche
	EEPchannel.postMessage({
		command:		"showID",
		ID: 			ID,
		/*
		GleissystemID: 	GleissystemID,
		GleisID: 		GleisID,
		shiftDown:		global.shiftDown,
		strgDown:		global.strgDown,
		altDown:		global.altDown,
		*/
	});
}

function _id (ID) {
	return `<a href="javascript:void(0);" onclick="javascript:postIDMessage(${ID});">`
				+ ID
				+ `<\/a>`
}

function getSignalPositionText (File, Position) {
	let Text = '';
	if (!Signalstellung[File]) {
		// no text
	} else if (typeof(Signalstellung[File].Pos[Position]) === "string") {
		Text = Signalstellung[File].Pos[Position];
	} else if (typeof(Signalstellung[File].Pos[Position]) === "object") {
		Text = Signalstellung[File].Pos[Position][EEP_Texts.getLanguage()]
			|| Signalstellung[File].Pos[Position].DE	// primary language
			|| Signalstellung[File].Pos[Position].EN	// secondary language
			;
	} else {
		// no text
	}
	
	// Default translations
	if (Text === "Fahrt") 	{ Text = _("Fahrt") };
	if (Text === "Halt") 	{ Text = _("Halt") };
	
	return Text;
}

function getSignalstellungenText (File) {
	let SignalstellungenText = '';
	if (Signalstellung[File]) {
		// 1st try: Get texts (case sensitive file name)
		for (const StellungPos in Signalstellung[File].Pos) {
			SignalstellungenText += StellungPos + ': ' + getSignalPositionText(File, StellungPos) + ', ';
		}
	} else {
		// 2nd try: Get texts (case insensitive file name)
		for (const SignalFile in Signalstellung) {
			if (SignalFile.toLowerCase() == File.toLowerCase()) {
				for (const StellungPos in Signalstellung[SignalFile].Pos) {
					SignalstellungenText += StellungPos + ': ' + getSignalPositionText(SignalFile, StellungPos) + ', ';
				}
			}
		}
	}
	return SignalstellungenText;
}

// Event handler to receive data
blockControlChannel.onmessage = function(event) {
	const command = event.data.command;
	
	if (command == "data") {
		const filename 		= event.data.filename;
		const blockSignals 	= event.data.blockSignals;
		const ignoredSignals = event.data.ignoredSignals;
		const twoWayBlocks 	= event.data.twoWayBlocks;
		const routes 		= event.data.routes;
		const trains 		= event.data.trains;
		const message 		= event.data.message;

		const extended 		= document.getElementById('extended').checked;
		
		const msg = document.getElementById('msg');
		msg.textContent = message || "";

		const data = document.getElementById('data');
		data.textContent = `Received! Time stamp: ${event.timeStamp}`;
		
		let text = []; 
		
		// Output header
		const GleissystemID = form.querySelector('input[name="GleissystemID"]:checked').value;
		text.push(`-- EEP ${_("Datei")} '${filename}'`); 
		text.push(`-- ` + EEP_Texts.getText("msg", 'LuaProgramBlockControl', TrackSystemText(GleissystemID)));
		
		// Output ignored signals
		if (ignoredSignals.length > 0) {
			let t = "-- Ignored signals: ";
			for (const entry of ignoredSignals) {
				t += `${_id(entry.SignalID)}, `;
			};
			text.push(t);
		}


		text.push("\nlocal main_signal = 0");

		// Output block signals
		if (!extended) {
			let t = "\nlocal block_signals = { ";
			for (const entry of blockSignals) {
				t += `${_id(entry.SignalID)}, `;
			};
			t += "}";
			text.push(t);

		} else {
			text.push("\nlocal block_signals = {");
			for (const entry of blockSignals) {
				text.push(`  ${_id(entry.SignalID)}, -- ${getSignalstellungenText(entry.name)}'${entry.name}' ${_("auf")} ${TrackSystemText(entry.GleissystemID)}-${entry.GleisID}`);
			};
			text.push("}");
			
		}

		// Output two way blocks
		if (!extended) {
			let t = "\nlocal two_way_blocks = { ";
			for (const entry of twoWayBlocks) {
				t += `{ ${_id(entry[0])}, ${_id(entry[1])} }, `;
			};
			t += "}";
			text.push(t);
			
		} else {
			text.push("\nlocal two_way_blocks = {");
			for (const entry of twoWayBlocks) {
				text.push(` { ${_id(entry[0])}, ${_id(entry[1])} }, `);
			};
			text.push("}");
			
		}
		
		// Output EEProutes
		text.push("\n-- " + _("allowedBlocks"));
		let maxTrainLength = 0;
		let maxEEProuteLength = 0;
		const EEProutes = {};
		for (const train of trains) {
			// Calculate max length of train names
			if (maxTrainLength < train.name.length) { maxTrainLength = train.name.length; }

			// Prepare table of EEP routes
			if (train.routeName && train.routeName != "") {
				if (!EEProutes[train.routeName]) {
					const varName = train.routeName 
									.replace(/ä/g, "ae")
									.replace(/ö/g, "oe")
									.replace(/ü/g, "ue")
									.replace(/Ä/g, "Ae")
									.replace(/Ö/g, "Oe")
									.replace(/Ü/g, "Ue")
									.replace(/ß/g, "ss")
									.replace(/\W/g, '_');
					EEProutes[train.routeName] = varName;

					// Calculate max length of train names
					if (maxEEProuteLength < varName.length) { maxEEProuteLength = varName.length; }
				}
			} else {
				EEProutes["all"] = "all";
				if (maxEEProuteLength < 3) { maxEEProuteLength = 3; }
			}
		}
		for (const routeName in EEProutes) {
			let t = `local ${EEProutes[routeName]}${" ".repeat(1+maxEEProuteLength - EEProutes[routeName].length)}= {`;
			for (const entry of blockSignals) {
				t += ` [${_id(entry.SignalID)}]=1,`;
			};
			t += ` }`;
			text.push(t);
		}

		// Output trains
		text.push("\nlocal trains = {");
		for (const train of trains) {
			const varName = EEProutes[train.routeName] || "all";
			text.push(` { name="${train.name}",${" ".repeat(1+maxTrainLength - train.name.length)}signal=0, allowed=${varName} ${" ".repeat(maxEEProuteLength - varName.length)}},`);
		}
		text.push("}");
		
		// Output routes
		text.push("\nlocal routes = {");
		for (const entry of routes) {
			let line = "";
			// Header
			if (!extended) {
				line +=  `  { ${_id(entry.startSignalID)}, ${_id(entry.SignalID)}, turn={`;
				
			} else {
				line += `\n  { ${_id(entry.startSignalID)}, turn={ -- Track`;
			}
			// Entries
			for (const turn of entry.turns) {
			
				if (turn.WeicheID) {
					const position = { "Ende" : 1, "EndeAbzweig" : 2, "EndeKoAbzweig" : 3 }[turn.Anschluss];
					if (!extended) {
						line += ` ${_id(turn.WeicheID)},${position},`;
					
					} else {
						line += `\n        ${_id(turn.WeicheID)},${position},`
							 +  ` -- Track`
							;
					}
		
				} else if (turn.GleisID) {
					if (!extended) {
						//line += "";
						
					} else {
						line += ` `
	//						 +  `${(turn.Anschluss === "Anfang" ? "+" : "-")}`
							 +	`${turn.GleisID}`
							;
					}
				}
			}
			// Footer
			if (!extended) {
				line +=   ` }},`;
				
			} else {
				line += `\n        },`
					 +  `\n    ${_id(entry.SignalID)} },`;
			}
			text.push(line);
		}
		text.push("}");
		
		text.push(LuaCode);

		// Output
//		data.textContent = text.join("\n");
		data.innerHTML = text.join("\n");
	}
}
</script>

</main>

</body>
</html>