<!DOCTYPE html>
<!-- 
Analyze .ini files of EEP

Definition:
https://wiki.eepshopping.de/index.php?title=Externe_*.ini-Dateien_der_Modelle 

Icons:
https://wiki.eepshopping.de/index.php?title=Modellicons 
-->
<html lang="de">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>Einstellungskombinationen von EEP-ini-Dateien</title>
<meta name="description" content="Dieses Programm liest .ini-Dateien und zeigt die darin enthaltenen Einstellungskombinationen an.">
<meta name="author" content="Frank Buchholz">
<meta name="keywords" content="EEP,.anl3,Rollmaterialien, Signale" />
<meta name="language" content="de" />
<link rel="icon" href="https://www.eepforum.de/images/favicon.ico" type="image/x-icon">

<style>
.hidden {
	display: none;
}

fieldset {
	border-width: 0;
	margin-inline-start: 0;
	margin-inline-end: 0;
	padding-block-start: 0;
	padding-inline-start: 0;
	padding-inline-end: 0;
	padding-block-end: 0;
}
</style>

<script type="text/javascript" src="js/EEP_Signale_Daten.js"></script><!-- Lade Zusatzdaten zu Signalen: Name, Signalstellung -->
<script type="text/javascript" src="js/EEP_MovableAxis_Data.js"></script><!-- Lade Zusatzdaten zu beweglichen Achsen -->

<script type="text/javascript">

<!-- - - - - - - -->

function readIniFiles(fileList) {
	// Selection screen
	document.getElementById("fileselector").classList.add("hidden");

	const promises = [];
	for (const file of fileList) {
		const filePromise = new Promise(resolve => {
			const reader = new FileReader();
			reader.readAsText(file, 'windows-1252');
			reader.onload = (ProgressEvent) => {
				resolve({
					file: file,
					section: parseIniString(reader.result)
				});
			}
		});
		promises.push(filePromise);
	}
	Promise.all(promises).then(iniFiles => {
		// iniFiles will be an array containing contents of the files
		const settingsCombinations = {};
		for (const iniFile of iniFiles) {
			iniFile.combination = {};	// Setting
			iniFile.settingsCombination = 0;	// Hash code which represents the set of settings
			
			// Is it a signal file?
			let section = 'Model_SignalFunc'; 			// specific section for signals
			let pattern = /^Pos(\d+)_Fn_Name_/ 			// Signal position: Pos01_Fn_Name_GER	
			if (!iniFile.section[section]) {
				// no signal file, let's try to interpret movable axis
				section = 'FileInfo';					// Movable axis
				pattern = /^MovAxis(\d+)_/;				// Movable axis: MovAxis3_GER
			}
			
			if (iniFile.section[section]) {
				for (const parameter in iniFile.section[section]) {

					const match = parameter.match(pattern);
					if (match) {
						const id = Number(match[1]);
						if (iniFile.combination[id]) {					// Only process the first entry per position/axis
							continue;
						}

						iniFile.combination[id] = {						// Get all languages in one step
							DE : iniFile.section[section][match[0] + 'GER'],
							EN : iniFile.section[section][match[0] + 'ENG'],
							FR : iniFile.section[section][match[0] + 'FRA'],
						}
						
						if (section == 'Model_SignalFunc') {			// Signals
							iniFile.combination[id].Pos = id;
						} else if (section == 'FileInfo') {				// Others
							iniFile.combination[id].MovAxis = id;
						}
					}
				}

				// Generate ID
				if (iniFile.combination != {}) {
					iniFile.settingsCombination = Math.abs(JSON.stringify(iniFile.combination).hashCode());
					/*
					Beispiele zu settingsCombinationen:
					[0256533125] = { 1 : Halt, 2 : Fahrt, }
					[1275122147] = { 1 : Fahrt, 2 : Halt, }
					*/
				}
				if (!settingsCombinations[iniFile.settingsCombination]) {
					settingsCombinations[iniFile.settingsCombination] = {
						combinationArray : iniFile.combination,
						Entries : [],
					};
				}
				// Cross reference
				settingsCombinations[iniFile.settingsCombination].Entries.push(
					iniFile.file.name.substr(0, iniFile.file.name.length - 4)
				);

			}
		}
		showIniFiles(iniFiles, settingsCombinations);
    });
}

String.prototype.hashCode = function() {
  let hash = 0;
  if (this.length === 0) return hash;
  for (let i = 0; i < this.length; i++) {
    const chr   = this.charCodeAt(i);
    hash  = ((hash << 5) - hash) + chr;
    hash |= 0; // Convert to 32bit integer
  }
  return hash;
};

function parseIniString(data){
	const regex = {
		section: /^\s*\[\s*([^\]]*)\s*\]\s*$/,
		param: /^\s*([^=]+?)\s*=\s*\"?(.*?)\"?\s*$/,
		comment: /^\s*;.*$/,
	};
	const value = {};
	const lines = data.split(/[\r\n]+/);
	let section = null;
	for (const line of lines) {
		if (regex.comment.test(line)) {
			continue;
		} else if (regex.param.test(line)) {
			const match = line.match(regex.param);
			if (section) {
				value[section][match[1]] = match[2];
			} else {
				value[match[1]] = match[2];
			}
		} else if (regex.section.test(line)) {
			const match = line.match(regex.section);
			value[match[1]] = {};
			section = match[1];
		} else if (line.length == 0 && section) {
			section = null;
		};
	}
	return value;
}

const Icons = { // Icons according to https://wiki.eepshopping.de/index.php?title=Modellicons
  [1] : `(Intern: Auswahl aus)`,
  [2] : `(Intern: Auswahl an)`,
  [3] : `(Intern: Verzeichnis zu)`,
  [4] : `(Intern: Verzeichnis auf)`,
  [5] : `Bahnsteig als Gleisobjekt oder Immobilie`,
  [6] : `Formsignal mit zwei Begriffen ("Fahrt" / "Halt")`,
  [7] : `Stadthaus (Ein- oder Mehrfamilienhaus)`,
  [8] : `Gruppe oder Reihe von mehreren Bäumen bzw. Büschen in einem Modell`,
  [9] : `Bewegliches (verladbares) Gut aller Art`,
  [10] : `Dampflokomotive`,
  [11] : `Historischer Personenwagen`,
  [12] : `Kesselwagen`,
  [13] : `Straßenbahn (vgl. Icon 77)`,
  [14] : `Transporter, Kleinbus`,
  [15] : `Kran, Verlademaschine`,
  [16] : `Kleineres Schiff oder Boot`,
  [17] : `Ziviles Propellerflugzeug`,
  [18] : `Modell mit Funktionsuhr`,
  [19] : `Fahne, Fahnenmast oder sonstiges Hoheitszeichen`,
  [20] : `Menschenfigur, hier: Mann bei der Arbeit`,
  [21] : `Menschenfigur, hier: Mann im Dienst`,
  [22] : `Menschenfigur, hier: Mann in der Freizeit`,
  [23] : `Standardeinstellung : Unbestimmt. Der Autor des Modells hat die Auswahl eines passenden Icons noch nicht getroffen!`,
  [24] : `Technische Einrichtung oder Gerät`,
  [25] : `Wintermodell`,
  [26] : `Einsatzfahrzeug (Krankenwagen, Rettungswagen, Notdienst, Hilfswerk etc.)`,
  [27] : `Größerer PKW, Sportwagen, SUV`,
  [28] : `Omnibus`,
  [29] : `Gegenstand oder Gut, das nicht verladen werden kann (Standmodell)`,
  [30] : `Soundmodul (Modell mit zugewiesenem Geräusch)`,
  [31] : `Loktender`,
  [32] : `Diesellokomotive`,
  [33] : `Elektrolokomotive`,
  [34] : `Formsignal mit mehreren Signalbegriffen (bis zu 10)`,
  [35] : `Schranke, Halbschranke, unbeschrankter Bahnübergang`,
  [36] : `Rollmaterial, das mit anderen Rollmaterialien befahren werden kann`,
  [37] : `Spline (Fahrweg)`,
  [38] : `Fahrrad (auch mit Personen besetzt)`,
  [39] : `Motorrad (auch mit Personen besetzt)`,
  [40] : `Kleinerer PKW`,
  [41] : `LKW, hier: geschlossener Kasten, Tankwagen`,
  [42] : `LKW, hier: offener (fester oder kippbarer) Pritschenaufbau`,
  [43] : `Traktor, landwirtschaftliche Maschine oder Gerät`,
  [44] : `Ziviles Kettenfahrzeug`,
  [45] : `Hubschrauber`,
  [46] : `Baumaschine und Baugerät (nicht nur mit Kettenantrieb)`,
  [47] : `Militärfahrzeug`,
  [48] : `Segelschiff, Segelboot, Segeljacht usw.`,
  [49] : `Einzelner Nadelbaum`,
  [50] : `Einzelner Laubbaum`,
  [51] : `Strauch oder Staude`,
  [52] : `Last- oder Arbeitstier`,
  [53] : `Landwirtschaftliches Nutztier`,
  [54] : `Haustier`,
  [55] : `Wildtier, europäisch`,
  [56] : `Menschenfigur, hier: Mädchen`,
  [57] : `Mehrere Menschenfiguren in einem Modell`,
  [58] : `Menschenfigur, hier: Frau im Dienst`,
  [59] : `Menschenfigur, hier: Frau bei der Arbeit`,
  [60] : `Menschenfigur, hier: Frau in der Freizeit`,
  [61] : `Menschenfigur, hier: Frau in der Freizeit (alternativ)`,
  [62] : `Menschenfigur, hier: Soldat`,
  [63] : `Industriebau`,
  [64] : `Historisches oder denkmalgeschütztes Bauwerk`,
  [65] : `Kirche, Sakralbau`,
  [66] : `Schloss, Burg`,
  [67] : `Immobilie, Bauwerk (allgemein)`,
  [68] : `Mühle, Pump- oder Schöpfwerk`,
  [69] : `Bauernhof, landwirtschaftlicher Betrieb`,
  [70] : `Schild, Informations- und Werbefläche`,
  [71] : `Stadthaus, Mehrfamilienhaus, Zeilenhaus`,
  [72] : `Hochhaus (die qualifizierenden 27 m Höhe müssen nicht erreicht werden)`,
  [73] : `Bahnhof, Empfangsgebäude als Gleisobjekt, oder Immobilie`,
  [74] : `Triebfahrzeuge der deutschen Bahn(en)`,
  [75] : `TGV. Steht stellvertretend für alle Triebfahrzeuge der französischen Bahnen`,
  [76] : `International verkehrendes Triebfahrzeug`,
  [77] : `Straßenbahn (s. auch Icon 13)`,
  [78] : `Tunneleinfahrt, Tunnelportal, Tunnelmodul`,
  [79] : `Bahnsteigzubehör, Zurüstteile (Anzeigetafeln, Fahrkartenautomaten, Bahnsteiguhren usw.)`,
  [80] : `Güterwagen, hier: Kühlwagen`,
  [81] : `Güterwagen, hier: offener Güterwagen`,
  [82] : `Güterwagen, hier: Rungenwagen`,
  [83] : `Güterwagen, hier: Staub- und Silo-Wagen`,
  [84] : `Güterwagen, hier: geschlossener Güterwagen`,
  [85] : `Güterwagen, hier: Plattform- und Containerwagen`,
  [86] : `Postwagen, Gepäckwagen, Gepäckabteilwagen`,
  [87] : `Reisezugwagen neuerer Bauart (ab Epoche IV)`,
  [88] : `Wagen des gehobenen Komforts, (TEE etc.)`,
  [89] : `Nahverkehrswagen`,
  [90] : `S- und U-Bahn-Wagen`,
  [91] : `Bus- und Straßenbahnzubehör als Immobilie (Haltestelle, Einstiegsinsel etc.)`,
  [92] : `U-Bahn-Zubehör als Immobilie oder Gleisobjekt (U-Bahn-Haltestelle etc.)`,
  [93] : `S-Bahn-Zubehör als Immobilie oder Gleisobjekt (S-Bahn-Haltestelle etc.)`,
  [94] : `Kreuzungsweichen-Signal (Wn) als Immobilie oder DKW-Gleisobjekt`,
  [95] : `Weichensignal (Wn), Weichenlaterne oder Weichenantrieb als Immobilie oder Gleisobjekt`,
  [96] : `Fahrleitungsmast, Ausleger, Quertragewerk oder Joch`,
  [97] : `Licht-Haupt- und Licht-Vorsignal, Lichtsignal nach DS/DV 301`,
  [98] : `Hl-Signal, Lichthaupt- und Lichtvorsignal (Hl) nach DV 301`,
  [99] : `Kombinationssignal (Ks), Kombinationssignal nach DS/DV 301`,
  [100] : `Hauptsignal (Signalsystem L) der SBB nach FDV (R 300.1-15)`,
  [101] : `Vorsignal (Signalsystem L) der SBB nach FDV (R 300.1-15)`,
  [102] : `Haupt- und Vorsignalverbindung`,
  [103] : `Signaltafel, als Signal oder Immobilie`,
  [104] : `Verkehrszeichen, Verkehrs-Informationstafel als Immobilie oder Signal`,
  [105] : `Verkehrsampel, als Signal oder Immobilie`,
  [106] : `Seefahrt-Zubehör, Bojen, Bootshäuser etc.`,
  [107] : `Gefahrgut, Gefahrgut-Behälter`,
  [108] : `Blumen, Blumenbeete, Gartenpflanzen etc.`,
  [109] : `Ziviles Düsenflugzeug`,
  [110] : `Heißluftballon, Zeppelin, Drachen etc.)`,
  [111] : `Militärflugzeug, unabhängig vom Antrieb`,
  [112] : `Brücke in offener Konstruktion`,
  [113] : `Brücke in massiver Konstruktion`,
  [114] : `Bahnbetriebswerk (Lokschuppen, Halle, Ausbesserungswerk etc.)`,
  [115] : `Stellwerke`,
  [116] : `Öffentliches Gebäude`,
  [117] : `Gras, krautige Niedrigpflanzen`,
  [118] : `Bootssteg, Anlegestelle als Gleisobjekt oder Immobilie`,
  [119] : `Gesteins- und Erdformationen`,
  [120] : `Gewässer`,
  [121] : `Feuerwehrfahrzeug, -gerätschaft`,
  [122] : `Modell mit Brand-Funktion`,
  [123] : `Menschenfigur, hier: Baby, Kleinkind`,
  [124] : `Menschenfigur, hier: Junge`,
  [125] : `Fuhrwerk, Wagengespann, Fuhrwerke, Kutsche`,
  [126] : `Wild-, Zoo- oder Zirkustier`,
  [127] : `Anhänger, als Rollmaterial oder Immobilie`,
  [128] : `Straßenlaterne, Parklaterne, Gleisbeleuchtung, Strahler etc.`,
  [129] : `Mauer, Gleismauer, Arkade etc.`,
  [130] : `Triebwagen der ÖBB`,
  [131] : `Triebwagen der DB`,
  [132] : `Triebwagen der SBB`,
  [133] : `Triebwagen`,
  [134] : `Zaun`,
  [135] : `Elektrische Einrichtung oder Gerätschaft`,
  [136] : `Radioaktive Einrichtung und Gerätschaften`,
  [137] : `Behältern, Tonne, Zisterne etc.`,
  [138] : `Wolkenkratzer`,
  [139] : `Fabrik, Industriegebäude in dem eine Produktion, Erzeugung oder Förderung stattfindet`,
  [140] : `Lagerhalle`,
  [141] : `Industrieanlage`,
  [142] : `Parkanlage`,
  [143] : `Passagier- oder Frachtschiff`,
  [144] : `Kleintier, Geflügel`,
  [145] : `Installation - Intern: Erfordert eine Zusatzinstallation von Komponenten`,
  [146] : `Modell mit Tauschtextur(en)`,
  [147] : `Fahrweg der mobilen Kamera`,
  [148] : `Straße als Spline`,
  [149] : `Straßenbahnschienen-Spline`,
  [150] : `Wasserweg als Spline`,
  [151] : `Zeigt im 3D-Editor das Modell der statischen Kamera`,
  [152] : `Zeigt im 3D-Editor das Modell der dynamischen Kamera`,
  [153] : `Zeigt im 3D-Editor das Modell der mobilen Kamera`,
  [154] : `Informationsmodell – Modell (nur Immobilien!) mit der Möglichkeit zur Anzeige eines Textes in 3D`,
  [155] : `animierte Vögel (Wasser, schwimmend)`,
  [156] : `animierte Vögel (Luft, fliegend)`,
  [157] : `Fische und andere Wassertiere (schwimmend)`,
  [158] : `Signale`,
  [159] : `intern`,
  [160] : `Tools`,
  [161] : `GBS`,
  [162] : `Drehscheibe als Gleisobjekt oder Immobilie`,
  [163] : `Schiebebühne als Gleisobjekt oder Immobilie`,
  [164] : `Feldweg/ Landwirtschaftsweg (einspurig)`,
  [165] : `Straßenlaternen`,
  [166] : `Fels als Landschaftselement`,
  [167] : `Felsformationen (Gruppen) als Landschaftselemente`,
  [168] : `Omegas von Trend`,
  [169] : `Omegas von Trend`,
  [170] : `intern`,
  [172] : `Rangiersignale`,
};

function showIniFiles(iniFiles, settingsCombinations) {
	const unknownOnly 	= document.getElementById('checkboxUnknownOnly').checked;
	const target 		= document.getElementById('container');
	let div, p;

	div = document.createElement('div');
	target.appendChild(div);

	if ( document.querySelector('input[name="outputFormat"]:checked').id === "list" ) {	// list, code

		// Show list grouped by settingsCombination
		for (const settingsCombination in settingsCombinations) {

			// Header
			p = document.createElement('p');
			div.appendChild(p);
			p.innerHTML =
				  `<b>Einstellungskombination ${('0000000000' + settingsCombination).slice(-10)}` + '</b><br>'
				;

			// settingsCombinations
			p = document.createElement('p');
			div.appendChild(p);
			if ( Object.keys(settingsCombinations[settingsCombination].combinationArray).length === 0 ) {
				p.innerHTML = '[empty]';
			} else {
				for (const combinationNr in settingsCombinations[settingsCombination].combinationArray) {
					const combination = settingsCombinations[settingsCombination].combinationArray[combinationNr];
					p.innerHTML +=
						combinationNr + ' : '
						+ (combination.DE ? '"' + combination.DE + '" ' : '')
						+ (combination.EN ? '"' + combination.EN + '" ' : '')
						+ (combination.FR ? '"' + combination.FR + '" ' : '')
						+ '<br>'
					;
				}
			}

			// Entries
			p = document.createElement('p');
			div.appendChild(p);
			for (const index in settingsCombinations[settingsCombination].Entries) {
				p.innerHTML +=
				  `${settingsCombinations[settingsCombination].Entries[index]}<br>`
				;
			}

		}

	} else {	// outputFormat = code

		// Stringify data for usage in EEP_Gleisplan.html and EEP_Inventar.html
		p = document.createElement('p');
		div.appendChild(p);
		p.innerHTML = 'const data = {';
		for (const iniFile of iniFiles) {
			let filename = iniFile.file.name.substr(0, iniFile.file.name.length - 4);
			if (!iniFile.section.Model_SignalFunc) {
				filename = filename.toUpperCase();												// Upper case file name for rolling stocks
			}
			
			if ( !unknownOnly || ( !Signalstellung[filename] && !MovableAxis[filename] ) ) {	// Ignore known data
			
			if ( Object.keys(iniFile.combination).length > 0 ) {

				p.innerHTML += `<br>&nbsp;&nbsp;"${filename}" : `+'{';							// Show file name as key 

				const FileInfo = iniFile.section.FileInfo;
				if (FileInfo) {
					p.innerHTML += '<br>&nbsp;&nbsp;&nbsp;&nbsp;Name : {'						// Show name as data
						+ (FileInfo.Name_GER ? `DE : "${FileInfo.Name_GER}", ` : '')
						+ (FileInfo.Name_ENG ? `EN : "${FileInfo.Name_ENG}", ` : '')
						+ (FileInfo.Name_FRA ? `FR : "${FileInfo.Name_FRA}", ` : '')
						+ '},'
						//+ `Desc = ${FileInfo.Description_GER}<br>`
						//+ `settingsCombination = ${iniFile.settingsCombination}<br>`
						;
						
					if (FileInfo.Icon) {
						p.innerHTML += '<br>&nbsp;&nbsp;&nbsp;&nbsp;Icon : ' + FileInfo.Icon + ',';					
					}	
				}

				p.innerHTML += '<br>&nbsp;&nbsp;&nbsp;&nbsp;'									// Show position for signals respective movable axis for others
					+ (iniFile.section.Model_SignalFunc ? 'Pos' : 'MovAxis' )
					+ ' : {'
				//p = document.createElement('p');
				//div.appendChild(p);
//				for (const id in iniFile.combination) {
				let index = 0;
				for (key of Object.keys(iniFile.combination).sort((a, b) => (a - b))) {			// Sorted output
					const entry = iniFile.combination[key];
					let id = key;
					if (entry.MovAxis) {
						index++;
						id = index; 
					}
					p.innerHTML += `<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;${id} : `
						+'{'
						+ (entry.DE ? `DE : "${entry.DE}", ` : '')
						+ (entry.EN ? `EN : "${entry.EN}", ` : '')
						+ (entry.FR ? `FR : "${entry.FR}", ` : '')
						+ (entry.MovAxis ? `axis : ${entry.MovAxis}, ` : '')
						+ '},'
					;
				}
				p.innerHTML += '<br>&nbsp;&nbsp;}},';
			}
			}
		}
		p.innerHTML += '<br>}';
	}
}
</script>
</head>
<body>

<h3>EEP .ini-Dateien</h3>

<section id='fileselector'> <!-- Selection screen -->

<form action='#' onsubmit="return false;"> <!-- better not to use inline listener, explizit register is better -->
	<label for="fileinput">Wähle und lade eine oder mehrere EEP .ini-Dateien</label>
	<input type='file' id='inifile' accept='.ini' multiple onchange='readIniFiles(this.files)'>
	<!-- An extra button is not neccessary -->
	<!-- <input type='button' id='btnLoad' value='Load' onclick='loadFile();'> -->
</form>
<p>Die .ini-Dateien im Ordner C:\EEP15\Resourcen.unp\ werden über das EEP-Programm mit der Funktion "Extras ⭢ Ressourcen-Extraktor" erstellt.</p>
<p>Die Ausgabe erfolgt gruppiert nach der Kombination der in der .ini-Datei enthaltenen Einstellungen. Dafür wird je Kombination eine eindeutige ID generiert.</P>

<form>
	<fieldset>
		Format der Ausgabe:
		<input type="radio" name="outputFormat" id="list" checked /><label for="list">Liste</label>
		<input type="radio" name="outputFormat" id="code" /><label for="code">Code</label>
		<input id="checkboxUnknownOnly" type="checkbox"><label for="checkboxUnknownOnly">Nur Daten zu bislang unbekannten Dateien anzeigen</label
	</fieldset>
</form>

<p><small>(c) Frank Buchholz, 2022</small></p>
</section> <!-- fileselector -->

<div id='container'></div>
</body>
</html>